{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}Planos de Carregamento{% endblock %}

{% block content %}

<div class="card">
  <div class="card-body">
    <div class="row">
        <div class="col-md-3">
          <label for="entriesSelect">Exibir:</label>
          <select id="entriesSelect" name="entriesSelect" class="form-select">
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
          </select>
        </div>

        <div class="col-md-3">
          <label for="ordenacaoSelect">Ordenação:</label>
          <select id="ordenacaoSelect" name="ordenacaoSelect" class="form-select">
              <option value="-data_inicio" selected>Data mais recente</option>
              <option value="data_mais_antiga">Data mais antiga</option>
          </select>
        </div>

        <div class="col-md-3">
          <label for="filtroSelect">Filtrar:</label>
          <select id="filtroSelect" name="filtroSelect" class="form-select">
              <option value="todos" selected>Todos</option>
              <option value="com_planilha">Com Planilha</option>
              <option value="sem_planilha">Sem Planilha</option>
          </select>
        </div>

        <!-- ✅ Botão "Criar Novo Plano" restaurado -->
        <div class="col-md-3 d-flex align-items-end justify-content-end">
          <a href="{% url 'plano_add' %}">
            <button class="btn btn-primary">
              <i class="bx bx-plus bx-sm me-1"></i> Criar novo plano
            </button>
          </a>
        </div>

    </div>
  </div>

  <div class="table-responsive text-nowrap mt-4">
    <table class="table" id="plano-table">
      <thead>
        <tr>
            <th>Abertura de senha</th>
            <th>Encerramento de senha</th>
            <th>Planilha</th>
            <th></th>
        </tr>
      </thead>
      <tbody class="table-border-bottom-0">
        {% for plano in planos %}
        <tr data-start-date="{{ plano.data_inicio }}" data-end-date="{{ plano.data_fim }}">
          <td>{{ plano.data_inicio }} {{ plano.horario_inicio }}</td>
          <td>{{ plano.data_fim }} {{ plano.horario_fim }}</td>
          {% if plano.planilha %} 
            <td><span class="badge bg-label-success me-1">Anexado</span></td> 
          {% else %} 
            <td><span class="badge bg-label-danger me-1">Não anexado</span></td> 
          {% endif %}
          <td>
            <div class="dropdown">
              <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                <i class="bx bx-dots-vertical-rounded"></i>
              </button>
              <div class="dropdown-menu">
                <a class="dropdown-item" href="{% url 'plano_edit' plano.id %}"><i class="bx bx-edit-alt me-1"></i> Editar</a>
                <a class="dropdown-item" href="{% url 'plano_delete' plano.id %}"><i class="bx bx-trash me-1"></i> Excluir</a>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const tableBody = document.querySelector("#plano-table tbody");
    const entriesSelect = document.getElementById("entriesSelect");
    const ordenacaoSelect = document.getElementById("ordenacaoSelect");
    const filtroSelect = document.getElementById("filtroSelect");

    function fetchPlanos(page = 1) {
        let limit = entriesSelect.value;
        let ordenacao = ordenacaoSelect.value;
        let filtro = filtroSelect.value;

        fetch(`{% url 'search_planos' %}?limit=${limit}&page=${page}&ordenacao=${ordenacao}&filtro=${filtro}`)
            .then(response => response.text())
            .then(html => {
                tableBody.innerHTML = html;
                updatePaginationListeners();
            })
            .catch(error => console.error('Erro na busca:', error));
    }

    function updatePaginationListeners() {
        document.querySelectorAll(".pagination-link").forEach(link => {
            link.addEventListener("click", function (e) {
                e.preventDefault();
                let page = this.dataset.page;
                fetchPlanos(page);
            });
        });
    }

    entriesSelect.addEventListener("change", () => fetchPlanos(1));
    ordenacaoSelect.addEventListener("change", () => fetchPlanos(1));
    filtroSelect.addEventListener("change", () => fetchPlanos(1));

    fetchPlanos();  // Chama a função ao carregar a página
});
</script>

{% endblock %}
