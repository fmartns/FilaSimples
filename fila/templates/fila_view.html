{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}Fila de Carregamento{% endblock %}

{% block content %}
<div class="container text-center mt-5">
    {% if plano_ativo %}
    {% elif plano_proximo_ou_ultimo %}
        <p>Não há um plano ativo no momento.</p>
        {% if plano_proximo_ou_ultimo.data_inicio >= today %}
            <p>O próximo plano acontecerá em {{ plano_proximo_ou_ultimo.data_inicio }} às {{ plano_proximo_ou_ultimo.horario_inicio }}</p>
        {% else %}
            <p>O último plano aconteceu em {{ plano_proximo_ou_ultimo.data_fim }} às {{ plano_proximo_ou_ultimo.horario_fim }}</p>
        {% endif %}
    {% else %}
        <p>Não há planos cadastrados.</p>
    {% endif %}
    
    {% if senha %}
        <h2 class="text-primary">Sua vez está chegando</h2>
        <p class="text-muted">Você está em uma sala de espera virtual e será atendido em breve. Acompanhe a estimativa de tempo.</p>
        
        <div class="progress-circle" id="progress-circle">
            <div class="progress-mask">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text" id="timer">{{ estimativa_tempo }}</div>
        </div>
        
        <p class="mt-3">Sua posição na fila: <strong>{{ posicao }}</strong></p>
        <p class="mt-3">Bancadas operando: <strong>{{ bancadas_operando }}</strong></p>
        
    {% else %}
        {% if plano_ativo %}
        <a href="{% url 'fila_entrar' %}">
            <button class="btn btn-primary" onclick="entrarNaFila()">
                <i class="bx bx-plus bx-sm me-1"></i> Entrar na fila
            </button>
        </a>
        {% endif %}
    {% endif %}
</div>

<style>
    .progress-circle {
        position: relative;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: conic-gradient(#FF6702 0% 0%, #e0e0e0 0% 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 20px auto;
    }
    .progress-mask {
        position: absolute;
        width: 130px;
        height: 130px;
        border-radius: 50%;
        background: white;
    }
    .progress-text {
        position: absolute;
        font-size: 24px;
        font-weight: bold;
        color: #FF6702;
    }
</style>

<script>
function entrarNaFila() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                let lat = position.coords.latitude;
                let lon = position.coords.longitude;

                // Redirecionar para a URL da view Django com as coordenadas
                window.location.href = `{% url 'fila_entrar' %}?latitude=${lat}&longitude=${lon}`;
            },
            function(error) {
                alert("Erro ao obter localização. Verifique as permissões de GPS e tente novamente.");
            }
        );
    } else {
        alert("Geolocalização não suportada pelo seu navegador.");
    }
}

document.addEventListener("DOMContentLoaded", function() {
    let timeLeft = {{ estimativa_tempo|default:'60' }};
    let timerElement = document.getElementById("timer");
    let progressFill = document.getElementById("progress-circle");
    
    function updateTimer() {
        if (timeLeft > 0) {
            timeLeft--;
            let minutes = Math.floor(timeLeft / 60);
            let seconds = timeLeft % 60;
            timerElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            let progress = (timeLeft / {{ estimativa_tempo|default:'0' }}) * 60;
            progressFill.style.background = `conic-gradient(#FF6702 ${progress}%, #e0e0e0 ${progress}% 100%)`;
            setTimeout(updateTimer, 1000);
        }
    }
    
    updateTimer();
});
</script>
{% endblock %}