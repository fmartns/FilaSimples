{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}Fila de Carregamento{% endblock %}

{% block content %}

<!-- {% if bancada_senha %}
<div class="container text-center mt-5">
    <h2 class="text-primary">Sua senha foi chamada</h2>
    <p class="text-muted">Dirija-se à bancada <strong>{{ bancada_senha }}</strong> para ser atendido.</p>
</div>
{% endif %} -->

<div class="container text-center mt-5">
    {% if plano_ativo %}
    {% elif plano_proximo_ou_ultimo %}
        <p>Não há um plano ativo no momento.</p>
        {% if plano_proximo_ou_ultimo.data_inicio >= today %}
            <p>O próximo plano acontecerá em {{ plano_proximo_ou_ultimo.data_inicio }} às {{ plano_proximo_ou_ultimo.horario_inicio }}</p>
        {% else %}
            <p>O último plano aconteceu em {{ plano_proximo_ou_ultimo.data_fim }} às {{ plano_proximo_ou_ultimo.horario_fim }}</p>
        {% endif %}
    {% else %}
        <p>Não há planos cadastrados.</p>
    {% endif %}
    
    {% if senha %}
        {% if senha.status == 1 %}
            <div class="bs-toast toast fade show bg-success" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <i class="bx bx-bell me-2"></i>
                    <div class="me-auto fw-medium">Senha</div>
                </div>
                <div class="toast-body">
                    Senha gerada com sucesso, aguarde ser chamado para o pátio interno!
                </div>
            </div>
        {% elif senha.status == 2 %}
            <div class="col-md-12 col-xxl-4 mb-6">
                <div class="bs-toast toast fade show bg-warning" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <i class="bx bx-bell me-2"></i>
                        <div class="me-auto fw-medium">Pátio Interno</div>
                    </div>
                    <div class="toast-body">
                        Você foi chamado para o pátio interno, entre e aguarde!
                    </div>
                </div>
            </div>
        {% elif senha.status == 3 %}
            <div class="col-md-12 col-xxl-4 mb-6">
                <div class="bs-toast toast fade show bg-success" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <i class="bx bx-bell me-2"></i>
                        <div class="me-auto fw-medium">Hora de carregar!</div>
                    </div>
                    <div class="toast-body">
                        Dirija-se à <strong>{{ bancada_senha }}</strong>
                    </div>
                </div>
            </div>
        {% endif %}
        {% if senha.status != 3 and senha.status != 5 and senha.status != 7 %}
            <div class="col-md-12 col-xxl-4 mb-6">
                <div class="card h-100">
                    <div class="d-flex align-items-end row">
                        <div class="col-7">
                            <div class="card-body">
                                <p class="mt-3">Sua posição na fila: <strong>{{ posicao }}</strong></p>
                                <p class="mt-3">Bancadas operando: <strong>{{ bancadas_operando }}</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endif %}

    {% if plano_ativo and not senha %}
        <a href="{% url 'fila_entrar' %}">
            <div class="row mt-4">
                <div class="d-grid gap-2 col-lg-6 mx-auto">
                    <button class="btn btn-primary btn-lg" type="button" onclick="entrarNaFila()">Gerar Senha</button>
                </div>
            </div>
        </a>
    {% elif plano_ativo and senha.status == 7 %}
        <p>Você já foi atendido, aguarde a próxima chamada.</p>
    {% endif %}
</div>

<script>
function entrarNaFila() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                let lat = position.coords.latitude;
                let lon = position.coords.longitude;

                // Redirecionar para a URL da view Django com as coordenadas
                window.location.href = `{% url 'fila_entrar' %}?latitude=${lat}&longitude=${lon}`;
            },
            function(error) {
                alert("Erro ao obter localização. Verifique as permissões de GPS e tente novamente.");
            }
        );
    } else {
        alert("Geolocalização não suportada pelo seu navegador.");
    }
}
</script>

{% endblock %}
